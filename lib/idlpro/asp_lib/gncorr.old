pro gncorr, imag, gntbl, out, ixst
;
;  purpose:  apply pixel-by-pixel gain correction to a Stokes I image
;	     using the gain tables generated by 
;
;  inputs:       imag = Stokes I image 
;		gntbl = pre-processed gain table from buildgn.pro
;		 ixst = index of first active X
;
;  output:       out  = gain corrected Stokes I image
;
;------------------------------------------------------------------------------
;
;	Get dimensions of input array.
;
nx = sizeof(imag, 1)
ny = sizeof(imag, 2)
nx1 = nx-1
ny1 = ny-1
out = imag
;
;	Get first dimension of gain table.
;
ng = sizeof(gntbl, 1)
ng1 = ng - 1
;
;	Set up for call_external.
;
numc = ng * 2 + 1
carr = fltarr(numc, /nozero)
i0 = 0				; start index for 1st array
i1 = ng1
i2 = i1 + 1			; start index for 2nd array
i3 = i2 + ng1
i4 = i3 + 1			; index for scalar
;
;	LOOP OVER PIXELS IN IMAGE.
;
for j = 0,ny1 do for i = ixst,nx1 do begin

;	Load values for call_external.
;
	carr(i0:i1) = gntbl(*,0,i,j)	; abscissa array (independent val's)
	carr(i2:i3) = gntbl(*,1,i,j)	; ordinate array (dependent val's)
	carr(i4)    = imag(i,j)		; abscissa for interpolation

;	Get linearly interpolated intensity.
;
	out(i,j)    = call_external('/home/hao/stokes/src/idl/aspinterp.so', $
				    '_aspinterp', float(carr), numc, /F_VALUE)
endfor
end
